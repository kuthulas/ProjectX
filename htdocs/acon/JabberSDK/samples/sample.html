<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=8,chrome=1">
    <script type="text/javascript" src="../src/ciscobase.js"></script>
    <!-- local -->
    <!--
        <script type="text/javascript" src="../cwic/cwic.js"></script>
     -->
    <!-- deployed -->
    <script type="text/javascript" src="../src/cwic/cwic.js"></script>
    <script type="text/javascript" src="../src/caxl/jabberwerx.js"></script>
    <script type="text/javascript" src="fullscreen.js"></script>
    <script type="text/javascript" src="sample_helpers.js"></script>

    <style type="text/css">
        body {
            font-size: 12px;
        }

        button#showpinpvideo {
            width: 60px;
            height: 20px;
            position: relative;
            border: 1px solid black;
        }
        button#showpinpvideo div.pinp {
            position: absolute;
            width: 25%;
            height: 25%;
            border: 1px solid black;
            background: #ffffff;
        }
        button#showpinpvideo.off div.pinp {
            border: #444;
            background: #ccc;
            top: 37%;
            left: 37%;
        }
        button#showpinpvideo.topleft div.pinp {
            top: 10%;
            left: 10%;
        }
        button#showpinpvideo.topright div.pinp {
            top: 10%;
            left: 65%;
        }
        button#showpinpvideo.bottomleft div.pinp {
            top: 65%;
            left: 10%;
        }
        button#showpinpvideo.bottomright div.pinp {
            top: 65%;
            left: 65%;
        }
        div.alignright {
            float: right;
        }
        #logindetails {
            width: 270px;
            /*height: 140px;*/
            border: 1px solid black;
        }

        #logindetails label {
            width: 33%;
            text-align: right;
            display: inline-block;
        }

        #logindetails input,
        #logindetails select {
            margin: 2px 0 0 0;
        }
        #logindetails input[type="text"],
        #logindetails input[type="password"] {
            width: 50%;
            padding-left: 4px;
        }
        ul#calllist,
        ul#calllist li {
            width: 400px;
            list-style-type: none;
            margin: 0;
            padding: 0;
        }
        ul#calllist li.selected {
            background: #ccc;
        }
        ul#calllist li span {
            padding: 3px;
        }
        ul#calllist li span.controls {
            display: none;
        }
        div.videocontainer {
        }
        div#videocontainer {
            position: relative;
            min-height: 273px;
            min-width: 364px;
            overflow: hidden;
            background-color: #c0c0c0;
            resize: both;
            padding: 5px;
            border: 1px solid #808080;
        }
        div#videocontainer object {
            min-height: 273px;
            height: 100%;
            width: 100%;
        }
        div#localPreviewContainer {
            border: 1px solid black;
            display: inline-block;
            vertical-align: top;
        }
        div#localPreviewContainer object {
            min-height: 150px;
            height: 100%;
            width: 100%;
        }
        div#localPreviewContainer div#localvidcontainer {
            min-height: 150px;
            min-width: 272px;
            max-width: 400px;
            resize: both;
            overflow: hidden;
            padding: 5px;
            border: 1px solid #808080;
            background-color: #c0c0c0;
        }
        div.callcontainer {
            /*
            width:300px;
            height:85px;
            */
            display:inline-block;
            background-color: AliceBlue;
            border:1px solid #aaaaaa;
            vertical-align: top;
        }

        div.callcontainer div.remotename {
            /*
            float: left;
            width: 300px;
            */
            height: 30px;
            background-color: LightGray;
        }

        div.callcontainer div.callinfo {
            /*
            float: left;
            width: 300px;
            */
            height: 30px;
        }

        div.callcontainer button.endbtn,
        div.callcontainer button.holdresumebtn,
        div.callcontainer button.muteaudiobtn,
        div.callcontainer button.mutevideobtn,
        div.incomingcontainer button.answerbtn,
        div.incomingcontainer button.divertbtn {
            float: right;
        }

        button.fullscreenbtn {
            display: none;
        }
        div.incomingcontainer {
            float: left;
            width: 200px;
            height: 60px;
            background-color: CadetBlue;
        }

        div.incomingcontainer div.message {
            float: left;
            width: 200px;
            height: 30px;
        }

        div#logindetails div#aboutcontainer {
            font-size: 10px;
            text-align: right;
        }

        div.IMcontainer {
            width: 300px;
            border: 1px solid #aaaaaa;
            padding: 0px;
            background-color: #ddd;
        }

        div.IMcontainer div.IMdialog {
            height: 300;
            overflow: auto;
            font-size: 10pt;
            font-family: Arial;
            padding: 5px;
        }

        div.webExcontainer {
            width: 400px;
            border: 1px solid #aaaaaa;
            background-color: AliceBlue;
            padding: 0px;
        }

        div.webExcontainer div.webExsetting {
            float: left;
            width: 400px;
            height: 30px;
            background-color: LightGray;
            font-weight:bold;
            font-size: 15px;
        }

        div.webExcontainer div.webExbuttons {
            float: left;
            width: 400px;
            height: 30px;
            background-color: LightGray;
        }

        iframe.loginFrame {
            display: none;
        }
        iframe#pinpwindow {
            position: absolute;
            border: 0;
            margin: 0;
            padding: 0;
            width: 25%;
            height: 25%;
        }
        iframe#pinpwindow.off {
            display: none;
        }
        iframe#pinpwindow.topleft {
            top: 5%;
            left: 5%;
        }
        iframe#pinpwindow.bottomleft {
            top: 70%;
            left: 5%;
        }
        iframe#pinpwindow.topright {
            top: 5%;
            left: 70%;
        }
        iframe#pinpwindow.bottomright {
            top: 70%;
            left: 70%;
        }

    </style>

    <script type="text/javascript">

    var popupwindow = null;
    var pinpwin = null;
    var thiswindow = window;
	var globalreg = null;

    function pinpLoaded(win,id) {
        thiswindow.pinpwin = win;
        if(id) {
            thiswindow.pinpVideoObject = $('#'+id,win.document)[0];
        var currentClass = $('#showpinpvideo').attr('class');
        var classId = pinpsequence.indexOf(currentClass);
        if(classId !==0) {
            $(document).cwic('addPreviewWindow',{previewWindow: thiswindow.pinpVideoObject, "window": thiswindow.pinpwin});
        }
        } else {
            if(jQuery(document).cwic('about').capabilities.video && !thiswindow.pinpVideoObject) {
                win.createVideoWindow();
            }
        }
    }
    function pinpUnloaded(win,id) {
        thiswindow.pinpwin = null;
        $(document).cwic('removePreviewWindow',{previewWindow: id, "window": win});
    }

    function popupLoaded(win,id) {
        var video = $('#videocall').is(":checked");
        thiswindow.popupwindow = win;
        if(video) {
            calls.getCallDiv().cwic('updateConversation', {addRemoteVideoWindow: id,"window":win});
        }
    }

    function popupUnloaded(win,id) {
        thiswindow.popupwindow = null;
    }

    /**
     * These settings are passed into the 'init' method.
     */
    var settings = {
        ready: phoneReadyCallback, /* Callback when phone is ready for use */
        error: phoneErrorCallback, /* Error callback */
        encodeBase64: ciscobase.util.crypto.b64Encode,
        verbose: true,
        log: function (msg, context) {
            //console.trace();
            if (typeof console !== "undefined" && console.log) {
                console.log(msg)
                if (context) {
                    if(console.dir) {
                        console.log(context);
                    } else if(JSON && JSON.stringify) {
                        console.log(JSON.stringify(context,null,2));
                    } else {
                        console.log(context);
                    }
                }
            };
        },
        contactLookupJsonpHost: "http://webcommunicator-dev"
    };

    // Array containing DTMF characters that we want to allow
    var dtmfchars = { '0' : '0', '1' : '1', '2':'2', '3':'3', '4':'4', '5':'5', '6':'6', '7':'7', '8':'8', '9':'9', '#':'#', '*':'*' };

    /*
     * Multiple-call settings
     */
    var calls = multiCallContainer('call', 'calllist');

    var videoObject = null;
    var previewVideoObject = null;
    var pinpVideoObject = null;

    var showLocalVideo = false;

    var caxl = caxlHelper("alpha-cup.cisco.com", "http://gwydlvm151:9080/hub20/alphahttpbinding", incomingMsgCallback, settings);

    /*
     * These are the WebEx integration settings
     */
    var WebEx = {
        ticket: '',
        site: '',
        username: '',
        password: ''
    };


    function popoutVideo() {
        var height = 520;
        var width = 700;
        if(popupwindow === null || popupwindow.closed) {
            var l = (screen.width-width)-16; // offset by 16 pixels for IE borders
            var t = 0;
            var windowsettings='height=' + height + ',width=' + width + ',top=' + t + ',left=' + l + ',location=no,resizable=yes,scrollbars=no,status=no,toolbar=no,menubar=no';
            var popupUrl="popout.html";
            popupwindow = window.open(popupUrl, "_cwicvideo", windowsettings);
            if(popupwindow !== null) {
                popupwindow.focus();
            }
        }
        else {
            popupwindow.focus();
        }
    }
    /**
     * This callback is invoked when the phone plugin is available for use.
     */
    function phoneReadyCallback(defaults,phoneRegistered, phoneMode) {
        $('#remotevideocontainer').cwic('createVideoWindow',{id: 'videocallobject', success: function(id) {
            videoObject = $('#'+id)[0];
            /*
            videoObject.addEventListener('videofocus', function() {
                //console.log("caught video object focus");
                setTimeout(function() {$('#videocontainer').focus();}, 250);
            },true);
            */
        }});
        $('#localvidcontainer').cwic('createVideoWindow',{id: 'localPreviewVideo', success: function(id) {
            previewVideoObject = $('#'+id)[0];
            /*
            previewVideoObject.addEventListener('videofocus', function() {
                //console.log("caught local video object focus");
                setTimeout(function() {$('#localvidcontainer').focus();}, 250);
                },true);
                 */
        }});
        if(pinpwin && pinpwin.createVideoWindow) {
            pinpwin.createVideoWindow();
        }
        var about = $('#phonecontainer').cwic('about');
        $('#jsversion').text(about.javascript.version);
        $('#jqueryversion').text(about.jquery.version);
        if (about.plugin) {
            $('#pluginversion').text(about.plugin.version.plugin);
            $('#eccversion').text(about.plugin.version.ecc);
        }

        setupUIHandlers();
        // Handle the login button's behavior
        $('#loginbtn').click(function() {
        /**
        * If we're in Deskphone mode, password is required. Not currently required for Softphone mode.
        */
            var authNeeded = !!($('#mode').val() === "DeskPhone" || $('#auth').attr('checked'));
            login($('#username').val(),$('#password').val(),$('#cucm').val(),authNeeded ,$('#mode').val());
        });

        // Handle the logout button's behavior
        $('#logoutbtn').click(function() {
            $('#incomingcontainer, #callcontainer').hide();
            $('#logoutbtn').attr('disabled', true);
            logout();
        });
        if(phoneRegistered) {
			$('#mode').val(phoneMode);
            setUILoggedIn();
        }
    };

    function phoneErrorCallback(error, exception) {
		if (error) {
			settings.log('phone error: ', error);
			var about = $().cwic('about');

			var msg = 'ERROR: cannot initialize phone: ' + error.message + ' (code ' + error.code + ')<br>';
			msg += 'cwic javascript version is ' + about.javascript.version + '<br>';

			if (about.upgrade) {
				if (about.upgrade.plugin) { msg += 'plugin upgrade ' + about.upgrade.plugin + '<br>'; }
				if (about.upgrade.javascript) { msg += 'cwic javascript upgrade ' + about.upgrade.javascript + '<br>'; }
			}

			$('#msgcontainer').empty().html('<b style="color:red">' + msg + '</b>');
		}

		if (exception) {
			settings.log('exception: ',exception);
		}
    };

    /*
     * When page is loaded, initialize the plugin.
     */
    $(document).ready(function() {
        $('#calllist').click(calls.callListClick);

        $('#mode').change(function() {
            $('#auth').attr('disabled',$(this).val() === 'DeskPhone');
        });
        $('#phonecontainer').cwic('init', settings);

        /**
         * Add handlers for conversationStart and conversationIncoming events
         */
        $('#phonecontainer')
        .bind('conversationStart.cwic', handleConversationStart)
        .bind('conversationIncoming.cwic', handleConversationIncoming)

        /**
         * Handle system events - these are issued when the webphone plugin is handling things like
         * IP address changes.
         */
        .bind('system.cwic', handleSystemEvent);

        $(document).bind('error.cwic', handleError);

        $('#switchmodebtn').click(switchModeClick);

		$('#showpinpvideo').click(switchPinPVideo);
		$('input:radio[name=showlocalvideo]').click(switchPreviewVideo);
		/**
        * Conference Feature
        */
		$('#conferencebtn').click(conferenceButtonClick);
		$('#transferbtn').click(transferButtonClick);



        /**
        * Initialise CAXL IM
        */
        caxl.init();
    });

    function handleLoggedOut() {
        calls.removeAll();
        $('#username').attr('disabled', false);
        $('#cucm').attr('disabled', false);
        $('#mode').attr('disabled', false);
        $('#auth').attr('disabled', false);
        $('#dntodial').attr('disabled', true);
        $('#loginbtn').attr('disabled', false);
        $('#logoutbtn').attr('disabled', true);
        $('#callbtn').attr('disabled', true);
        $('#switchmodebtn').attr('disabled', true);

        // Once logout has completed, unbind all handlers that are bound in login
        // On second thought, don't
    }

    function unbindCallHandlers() {
        $('#callbtn').unbind();
        $('#callcontainer').unbind();
        $('#callcontainer :button').unbind();
        $('#IMcontainer :button').unbind();
        $('#webExcontainer :button').unbind();
    }
    /**
     * Helper function to logout
     */
    function logout(){

        $('#phonecontainer').cwic('unregisterPhone', {
            forceLogout: true,
            // the complete callback is always called after unregistering
            complete: function(){
                handleLoggedOut();
            }
        });
    };

    /**
    * Set up the UI's handlers for clicks and cwic events. Doing this once prevents bugs from multiple
    * events being fired
    */
    function setupUIHandlers() {
        $('#popoutbtn').click(popoutVideo);
        $('#callbtn').click(callButtonClick);
        $('#callcontainer .holdresumebtn').click(holdResumeButtonClick);
        $('#callcontainer .muteaudiobtn').click(muteButtonClick);
        $('#callcontainer .mutevideobtn').click(muteButtonClick);
		$('#callcontainer .escalatebtn').click(escalateButtonClick);

        $('#dntodial').keypress( function (event) {
            var conversation = calls.getSelectedCall();
            if(conversation && conversation.capabilities.canSendDigit) {
                var char = String.fromCharCode(event.charCode || event.keyCode);
                if(dtmfchars[char]) {
                    calls.getCallDiv().cwic('sendDTMF', char);
                }
            }
        });

        $('#callcontainer .endbtn').click(endButtonClick);

        // IM/CAXL handlers
        $('#callcontainer .IMbtn').click( function() {
            var convData = $('#callcontainer').data('cwic');
            caxl.resolveJabberId(convData, function(remotejid) {
                if (remotejid) {
                    $('#IMcontainer').show();
                    //Store the remotejid in the IMcontainer's send button object
                    $('#IMcontainer .sendbtn').attr('disabled', false).data('remotejid', remotejid);
                } else {
                    $('#IMcontainer .sendbtn').attr('disabled', true);
                }
            });

        });


        $('#IMcontainer .sendbtn').click(function() {
            var remotejid = $(this).data('remotejid');
            if(remotejid) {
                var msg = $('#IMsender').val();
                if(msg !== '') {
                    var success = caxl.sendMessage(remotejid, msg);
                    if(!success) {
                        alert("Cannot send IM! Check IM server or if remote user login.");
                    }
                    $('#IMcontainer .IMsender').focus();
                    addMessage(remotejid, msg, 'client');
                    $('#IMsender').val("");
                }
            }
            else{
                alert("Jabber ID can not be resolved!");
                $('#IMcontainer .sendbtn').attr('disabled', true);
            }

        });

        $('#IMcontainer .closebtn').click( function() {
            $('#IMcontainer').hide();
         });

        // WebEx handlers
        $('#callcontainer .webExbtn').click( function() {
            $('#webExcontainer').show();
        });

        $('#webExcontainer .webExclosebtn').click( function() {
            $('#webExcontainer').hide();
         });

        $('#webExcontainer .applybtn').click(function() {
            WebEx.password = $('#webExpassword').val();
                        WebEx.username = $('#webExusername').val();
                        WebEx.site = $('#webExaddress').val();
                        $('#msgcontainer').text("Signing in...");
                                    var backupURL = window.location.toString();
                                    $('#backupURL,#imbackupURL').val(backupURL.replace('/sample.html','/bu.html'));
                        loginURL();
        });
        $('#webExcontainer .startMeeting').click(function() {
            $('#tckt').val(WebEx.ticket);
            $('#wbxid').val(WebEx.username);
            $('#impromptuMeeting').attr('action','https://'+WebEx.site+'.webex.com/'+WebEx.site+'/m.php');
            $('#impromptuMeeting').submit();
        });
    };

    /**
     * preview video radio toggle handler
     */
    function switchPreviewVideo(evt) {
        if(showLocalVideo !== evt.target.value) {
            showLocalVideo = evt.target.value;
            if(showLocalVideo === "On") {
                $(document).cwic('addPreviewWindow',{previewWindow: previewVideoObject});
            } else {
                $(document).cwic('removePreviewWindow',{previewWindow: previewVideoObject});
            }
        }
    }
    /**
     * switch position/visibility of picture-in-picture
     */
    var pinpsequence = ['off','bottomright','bottomleft','topleft','topright'];
    function switchPinPVideo(evt) {
        var currentClass = $('#showpinpvideo').attr('class');
        var classId = pinpsequence.indexOf(currentClass) + 1;
        if(classId >= pinpsequence.length) {
            classId = 0;
        }
        $('#showpinpvideo').attr('class',pinpsequence[classId]);
        $('#pinpwindow').attr('class',pinpsequence[classId]);
        if(classId ===0) {
            $(document).cwic('removePreviewWindow',{previewWindow: pinpVideoObject, "window": pinpwin});
        } else {
            $(document).cwic('addPreviewWindow',{previewWindow: pinpVideoObject, "window": pinpwin});
        }
    }
    /**
     * Set the UI state to logged in
     */
    function setUILoggedIn() {
        $('#msgcontainer').empty();
        $('#username').attr('disabled', true);
        $('#dntodial').attr('disabled', false);
        $('#cucm').attr('disabled', true);
        $('#mode').attr('disabled', true);
        $('#auth').attr('disabled', true);
        $('#loginbtn').attr('disabled', true);
        $('#logoutbtn').attr('disabled', false);
        $('#switchmodebtn').removeAttr('disabled');
        $('#callbtn').removeAttr('disabled');
    };
    /**
     * Login the webphone.
     */
    function login(user,password,cucm,auth,phoneMode){
        // magic number for encoded password length and trailing char, may break in the future
        if(password.length === 44 && password[43] === '=') {
            password = { "cipher" : "cucm", "encrypted": password};
        }
        $('#loginbtn').attr('disabled', true);
        $('#phonecontainer').cwic('registerPhone', {
            user: user,
            password: password,
            cucm: {
                tftp: [cucm],
                ccmcip: [cucm]
            },
            mode: phoneMode,
            authenticate: auth,

            devicesAvailable: function(devices,phoneMode,callback,automatic) {
                $('#devices').children().remove();
                var deviceSelected = false;
                for(var i=0;i<devices.length;i++)  {
                    if((phoneMode === "SoftPhone" && devices[i].isSoftPhone) || (phoneMode === "DeskPhone" && devices[i].isDeskPhone)) {
                        if(automatic && !deviceSelected) {
                            callback(phoneMode,devices[i].name,'');
                            deviceSelected = true;
                        }
                        if(phoneMode === "SoftPhone") {
                            $('#devices').append($('<option>', {value: devices[i].name+":"}).text(devices[i].name).attr('title',devices[i].modelDescription));
                        } else {
                            for(var j=-1;j<devices[i].lineDNs.length;j++) {
                                $('#devices').append($('<option>', {value: devices[i].name+":"+(j>=0 ? devices[i].lineDNs[j] : '')}).text((j>=0 ? devices[i].lineDNs[j]+' : ' : '')+devices[i].name).attr('title',devices[i].modelDescription));
                            }
                        }
                    }
                }
                $('#connectbtn').unbind('click').attr('disabled', false);
                $('#connectbtn').bind('click', function() {
                    $(this).attr('disabled', true);
                    var device= $('#devices').val().split(':');
                    if(device) {
                        callback(phoneMode, device[0],device[1]);
                    }
                }).removeAttr('disabled');
            },
            /**
             * Callback that's invoked when phone is successfully registered.
             * Use this callback to enable UI controls etc to enable calls to be made.
             */
            success: function(registration) {
				settings.log('Registration succeeded. Registration: ',registration);
				globalreg = registration;
            },
            /**
             * Callback that's invoked if registration fails for some reason.
             */
            error: handleLoginFailure
        }); // End of registerPhone
    } // End of login


    function updateConversationInfo(conversation, callcontainer){
        if(!calls.getSelectedCall() || calls.getSelectedCall().callId !== conversation.callId) {
            return;
        }
        var $callcontainer = $(callcontainer);
        updateTransferConferenceLists(conversation);
        $callcontainer.css('display','inline-block');
		if(conversation.isConference) {
			$callcontainer.find('.remotename').text("Conference");
		}
        else if(conversation.callType === "Outgoing") {
            $callcontainer.find('.remotename').text(conversation.calledPartyDirectoryNumber);
        }
        else if (conversation.callType === "Incoming") {
            $callcontainer.find('.remotename').text(conversation.callingPartyDirectoryNumber);
        }
        $callcontainer.find('.callinfo').text(conversation.callState);

        if (conversation.callState === 'Hold' || conversation.callState === 'RemHold') {
            $callcontainer.find('.holdresumebtn').attr('disabled', !conversation.capabilities.canResume).text('Resume').addClass('held');
        } else {
            $callcontainer.find('.holdresumebtn').attr('disabled', !conversation.capabilities.canHold).text('Hold').removeClass('held');
        }
        $callcontainer.find('.endbtn').attr('disabled', !conversation.capabilities.canEndCall);

        if (conversation.state === 'Reorder') {
            $callcontainer.find('.callinfo').text('Call failed');
        }

        if(conversation && conversation.callState === "Connected" && (conversation.videoDirection === "RecvOnly" ||  conversation.videoDirection === "SendRecv")) {
            if(videoObject) {
                calls.getCallDiv().cwic('updateConversation',{'addRemoteVideoWindow':videoObject});
            }
            if(popupwindow && !popupwindow.closed && popupwindow.videoObject) {
                calls.getCallDiv().cwic('updateConversation',{'addRemoteVideoWindow':popupwindow.videoObject,window:popupwindow});
            }
        }
        if(conversation.audioMuted) {
            $callcontainer.find('.muteaudiobtn').attr('disabled', !conversation.capabilities.canUnmuteAudio);
            $callcontainer.find('.muteaudiobtn').text('Unmute Audio').addClass('muted');
        } else {
            $callcontainer.find('.muteaudiobtn').attr('disabled', !conversation.capabilities.canMuteAudio);
            $callcontainer.find('.muteaudiobtn').text('Mute Audio').removeClass('muted');
        }

        if(conversation.videoMuted) {
            $callcontainer.find('.mutevideobtn').attr('disabled', !conversation.capabilities.canUnmuteVideo);
            $callcontainer.find('.mutevideobtn').text('Unmute Video').addClass('muted');
        } else {
            $callcontainer.find('.mutevideobtn').attr('disabled', !conversation.capabilities.canMuteVideo);
            $callcontainer.find('.mutevideobtn').text('Mute Video').removeClass('muted');
        }

		if(conversation.videoDirection === "Inactive") {
            $callcontainer.find('.escalatebtn').text('Escalate').attr('disabled',!conversation.capabilities.canUpdateVideoCapability);
        } else {
            $callcontainer.find('.escalatebtn').text('De-escalate').attr('disabled',!conversation.capabilities.canUpdateVideoCapability);
        }


    }
    /*
    * IM integration functions
    */
    function addMessage(who, msg, cls) {
        var dialogDiv = $('#IMdialog');
        dialogDiv.append($("<div class='msg_" + cls + "'><b>"
                       + who + ":</b> " + msg + "</div>"));
        dialogDiv[0].scrollTop = dialogDiv[0].scrollHeight;
    }

        /*
    function sendMessage(caxlCls,remoJid) {
        var msg = $('#IMsender').val();
        if (msg == '') {
            //alert("Enter your message!");
            return;
        }
        else{
            try{
                caxlCls.sendMessage(remoJid, msg);
            }
            catch(ex){
                if(console.trace) console.trace();
                settings.log(ex.message);
                alert("Cannot send IM! Check IM server or if remote user login.");
            }
            $('#IMcontainer .IMsender').focus();
            addMessage(jid, msg, 'client');
            $('#IMsender').val("");
        }
    }
    function resolveJabberId(conv){
        var photo = "yes";
        if(conv.participant.name && !remoteJid){
            dialXhr = jQuery.get('/quickcontact/name/' + conv.participant.name + '?photo=' + photo, function(contacts) {
                if (!contacts) {
                    $('#callcontainer .IMbtn').attr('disabled', true);
                    }
                jQuery.each(contacts, function(i, contact) {
                    if (contact.phoneNumbers.work == conv.participant.recipient) {
                        remoteJid = contact.screenName + '@' + 'alpha-cup.cisco.com';
                    }
                });
            if (remoteJid) {
                $('#callcontainer .IMbtn').attr('disabled', false);
                $('#IMcontainer .sendbtn').attr('disabled', false);
            }
            });
        }
    }
    */

    function processKey(event) {
        if (event.keyCode == 13) {
            if (remoteJid) {
                sendMessage(client,remoteJid);
            }
            else{
                alert("Jabber ID can not be resolved!");
                $('#IMcontainer .sendbtn').attr('disabled', true);
            }
            return false;
        } else {
            return true;
        }
    }

    /*
     * WebEx integration functions
     */
    function loginBU(result) {
        if(result.AT === "LO") {
            if(result.ST === "SUCCESS") {
                $('#msgcontainer').text('iFrame URL logout SUCCESS.');
            } else {
                $('#msgcontainer').text('iFrame URL logout result: '+ result.RS);
                }
                }
        if(result.AT === "LI") {
            if(result.ST === "SUCCESS") {
            $('#webExcontainer .startMeeting').show();
            $('#msgcontainer').text('iFrame URL login SUCCESS.');
            } else {
                $('#msgcontainer').text('iFrame URL login result: '+ result.RS);
            }
        }
    }
    function meetingBU(result) {
            if(result.ST === 'SUCCESS') {
                $('#msgcontainer').text('iFrame URL Impromptu meeting SUCCESS.');
            } else {
                $('#msgcontainer').text('iFrame URL Impromptu meeting result: '+ result.RS);
            }
    }
    function otherBU(result) {
        $('#msgcontainer').text('iFrame URL other BU result: '+ result.RS);
    }
    function loginURL() {
        $('#act').val("LI");
        $('#webexid').val(WebEx.username);
        $('#passwd').val(WebEx.password);
        $('#urlLogin').attr('action','https://'+WebEx.site+'.webex.com/'+WebEx.site+'/p.php');
        $('#urlLogin').submit();
    };


    function getCwicClasses(el) {
        var classes = jQuery(el).attr('class');
        var classestoadd = [];
        if(classes) {
            classes = classes.split(' ');
            for(var i=0;i<classes.length;i++) {
                if(classes[i].substring(4,0) === 'cwic') {
                    classestoadd.push(classes[i]);
                }
            }
        }
        return classestoadd.join(' ');
    }
    function handleConversationStart(event, conversation, containerdiv) {
        $('#IMcontainer .IMdialog .msg_client').remove();
        $('#IMcontainer .IMdialog .msg_me').remove();
        $('#IMcontainer').hide();
        calls.addCall(conversation, containerdiv);
		updateConversationInfo(conversation, '#callcontainer');
    };

    function handleConversationIncoming(event, conversation, containerdiv) {
        calls.addCall(conversation, containerdiv);
    };

    function handleSystemEvent(event) {
        var reason = event.phone.status || null;
        settings.log('system event with reason=' + reason);

        if (reason == 'eRecoveryPending') {
            settings.log('recovery pending, end any active call and disable make call');

            //handleLoggedOut();
            $('#msgcontainer').empty().text('System recovery is pending ...');
            $('#callbtn').attr('disabled', true);
        }
        else if (reason == 'eIdle') {
            handleLoggedOut();
        }
        else if (reason == 'eReady') {
            $('#msgcontainer').empty();
            settings.log('phone is ready, enable make call');
            setUILoggedIn();
            initCaxl();
        }
		else if (reason == 'ePhoneModeChanged') {
			$('#mode').val(event.phone.registration.mode);
		}
        else {
            settings.log('ignoring system.cwic event with reason=' + reason);
        }
    };

    function handleError(error) {
        var msg = (error.message || '') + '<br>';
        msg += error.details.join('<br>');

        try {
            if (error.nativeError) {
                msg += '<br> native error: ' + JSON.stringify(error.nativeError);
            }
        }
        catch(e) {
            if(typeof console !== "undefined" && console.trace) {
                console.trace();
            }
        }

        $('#msgcontainer').empty().html(msg);
    };

    function incomingAnswerClick() {

        var videodirection = $('#videocall').is(':checked');
        var $call = $(this).parent().parent();
        if (videodirection) {
            var answerObject = $call.data('cwic');
            answerObject.videoDirection = 'SendRecv';
            if(videoObject) {
                answerObject.remoteVideoWindow = videoObject;
            } else {
                answerObject.remoteVideoWindow = 'videocallobject';
            }
            $call.cwic('startConversation', answerObject);

        }
        else{
            $call.cwic('startConversation',$call.data('cwic'));
        }

   };

   function incomingDivertClick() {
        var $call = $(this).parent().parent();
        $call.cwic('endConversation',true);
   };

   function switchModeClick(){
        var modechange;
        if($('#mode').val()=='SoftPhone') {
            modechange="DeskPhone";
        }
        else {
            modechange='SoftPhone';
        }
        authNeeded = ($('#mode').val() === "DeskPhone" || $('#auth').attr('checked'));
        $('#callbtn').attr('disabled', true);
        $('#switchmodebtn').attr('disabled', true);
        $('#switchmodebtn').cwic('switchPhoneMode', {
            mode: modechange,
            error: handleLoginFailure
        });
		calls.removeAll();
    };

    function initCaxl() {
        if(!caxl.connect($('#username').val(), $('#password').val())) {
            $('#callcontainer .IMbtn').attr('disabled', true);
            alert("Cannot connect to IM server!");
        }
        settings.log('Connect to IM server.');
    };

    /*
    function initCaxl() {
        client = new jabberwerx.Client();
        settings.log(client);
        jabberwerx._config.httpBindingURL = "http://gwydlvm151:9080/hub20/alphahttpbinding";
        jabberwerx._config.unsecureAllowed = true;
        jabberwerx._config.persistDuration = 0;
        //Receive IM
        client.event("messageReceived").bind(function(evt) {
        var message = evt.data;
        var body = message.getBody();
        if (body) {
            $('#IMcontainer').show();
            remoteJid = message.getFrom().substring(0, message.getFrom().indexOf('/'));
            addMessage(message.getFrom().substring(0, message.getFrom().indexOf('/')) , body, 'me');
            settings.log('IM has received!');
            }
        });
    };
    */

    function callButtonClick() {
        var dn = $('#dntodial').val();
        var videodirection = $('#videocall').is(':checked');
        var originateObject = {participant: {recipient: dn}, videoDirection: (videodirection ? 'SendRecv':'')};
        if(videodirection) {
            if(videoObject && videoObject.windowhandle && videoObject.windowhandle !== "00000000") {
                originateObject.remoteVideoWindow = videoObject;
            } else {
                originateObject.remoteVideoWindow = 'videocallobject';
            }
        }
		if (dn !=""){
        $('#phonecontainer').cwic('startConversation',originateObject);
        $('#switchmodebtn').attr('disabled', true);
		}
    };

    function holdResumeButtonClick() {
        if($(this).hasClass('held')) {
            calls.getCallDiv().cwic('updateConversation', 'resume');
        } else {
            calls.getCallDiv().cwic('updateConversation', 'hold');
        }
    };

    function muteButtonClick() {
        var muteIsAudio = true;
        if($(this).hasClass('mutevideobtn')) {
            muteIsAudio = false;
        }
        if($(this).hasClass('muted')) {
            calls.getCallDiv().cwic('updateConversation', muteIsAudio? 'unmuteAudio' : 'unmuteVideo');
        } else {
            calls.getCallDiv().cwic('updateConversation', muteIsAudio? 'muteAudio' : 'muteVideo');
        }
    };

    function endButtonClick() {
        calls.getCallDiv().cwic('endConversation');
    };

    function handleConversationUpdate(event, conversation, container) {
        settings.log('conversationUpdate Event for conversation:'+conversation.callId+' on Dom node: ' + event.target.id, conversation);
        calls.addCall(conversation, container);
        updateConversationInfo(conversation, $('#callcontainer'));

        //resolve Jabber ID when conversation update
        caxl.resolveJabberId(conversation, function(remotejid) {
            if(remotejid) {
                $('#callcontainer .IMbtn').attr('disabled', false);
                $('#IMcontainer .sendbtn').attr('disabled', false);
            } else {
                $('#callcontainer .IMbtn').attr('disabled', true);
                $('#IMcontainer .sendbtn').attr('disabled', true);
            }
        });

    };

    function handleConversationEnd(event, conversation) {
        $('#callcontainer').hide();
		calls.removeCall(conversation.callId);
        settings.log('conversationEnd Event for conversation:'+conversation.callId);

    };

    function incomingMsgCallback(remoteJid, message) {
        $('#IMcontainer').show();
        addMessage(message.getFrom().substring(0, message.getFrom().indexOf('/')) , message.getBody(), 'me');
    };

    function handleLoginFailure(error) {
        var msg = 'Unable to login: ' + error.message+' ';
        msg += error.details.join(', ');
        $('#msgcontainer').html(msg);
        $('#phonecontainer').cwic('unregisterPhone', {
            forceLogout: true
        });
        $('#username').attr('disabled', false);
        $('#cucm').attr('disabled', false);
        $('#mode').attr('disabled', false);
        $('#auth').attr('disabled', false);
        $('#loginbtn').attr('disabled', false);
        $('#logoutbtn').attr('disabled', true);
        $('#callbtn').attr('disabled', true);
        $('#switchmodebtn').attr('disabled', true);
        $('#callbtn').attr('disabled', true);
    };

	function transferButtonClick() {
		var transferCallId = $("#transferlist option:selected").val();
		var currentCall = calls.getSelectedCall();
        if(currentCall.callId !== transferCallId) {
            calls.getCallDiv().cwic('updateConversation', {'transferCall':transferCallId});
        }
    }
	function conferenceButtonClick() {
		var joinCallId = $("#conferencelist option:selected").val();
        var joinCall = calls.getCall(joinCallId);
		var currentCall = calls.getSelectedCall();

        if(!joinCall || !currentCall) {
            settings.log("Call does not exist");
            return;
        }
        var currentParticipants = (currentCall.isConference ? currentCall.participants.length : 1);
        var joinParticipants = (joinCall.isConference ? joinCall.participants.length : 1);
        // if 2 conference calls are joined, we get a conference with n+1 participants one of whom is a conference, not n+m participants
        if(currentCall.isConference && joinCall.isconference) {
            joinParticipants = 1;
        }
        // maxParticipants is either 0 (if not a conference), a positive number if the call is a conference, or -1 if it cannot be determined
        // if -1, we attempt to conference anyway - at worst it just won't conference and the calls are left as is
        if((joinCall.isConference && (joinCall.maxParticipants == -1 || (currentParticipants + joinParticipants > joinCall.maxParticipants))) || (currentCall.isConference && (currentCall.maxParticipants == -1 || (currentParticipants + joinParticipants > currentCall.maxParticipants)))) {
            settings.log("Cannot join calls, max participants exceeded.");
            return;
        }
        calls.getCallDiv().cwic('updateConversation', {'joinCall':joinCallId});
    };

	function updateTransferConferenceLists(conversation) {
        var existingCalls = calls.getCalls();
        var text = '';
        $('#conferencelist').empty();
        $('#transferlist').empty();
        var conferenceAvailable = false;
        var transferAvailable = false;
        if(conversation && conversation.callState === "Connected") {
            for(var call in existingCalls) {
                if(existingCalls.hasOwnProperty(call)) {
                    if(conversation.capabilities.canJoinAcrossLine && existingCalls[call].callId !== conversation.callId && existingCalls[call].capabilities.canJoinAcrossLine) {
                        if(existingCalls[call].isConference) {
                            text = "Conference";
                        } else if(existingCalls[call].callType === "Outgoing") {
                            text=existingCalls[call].calledPartyDirectoryNumber;
                        } else {
                            text=existingCalls[call].callingPartyDirectoryNumber;
                        }
                        $('#conferencelist').append("<option value='" + existingCalls[call].callId + "'>" + text + "</option>");
                        conferenceAvailable = true;
                    }
                    if(conversation.capabilities.canDirectTransfer && existingCalls[call].callId !== conversation.callId && existingCalls[call].capabilities.canDirectTransfer) {
                        if(existingCalls[call].isConference) {
                            text = "Conference";
                        } else if(existingCalls[call].callType === "Outgoing") {
                            text=existingCalls[call].calledPartyDirectoryNumber;
                        } else {
                            text=existingCalls[call].callingPartyDirectoryNumber;
                        }
                        $('#transferlist').append("<option value='" + existingCalls[call].callId + "'>" + text + "</option>");
                        transferAvailable = true;
                    }
                }
            }
        }
        $('#conferencebtn').attr('disabled', !conferenceAvailable);
        $('#transferbtn').attr('disabled', !transferAvailable);
    };

	function escalateButtonClick() {
		var currentCall = calls.getSelectedCall();
		var $callcontainer = $('#callcontainer');
		if (currentCall.videoDirection === "Inactive") {
			calls.getCallDiv().cwic('updateConversation', {videoDirection:'SendRecv'});
			$callcontainer.find('.escalatebtn').text('De-escalate');
		}
		else if (currentCall.videoDirection === "SendRecv") {
			calls.getCallDiv().cwic('updateConversation', {videoDirection:'Inactive'});
			$callcontainer.find('.escalatebtn').text('Escalate');
		}
		else if (currentCall.videoDirection === "SendOnly") {
			calls.getCallDiv().cwic('updateConversation', {videoDirection:'Inactive'});
			$callcontainer.find('.escalatebtn').text('Escalate');
		}
		else if (currentCall.videoDirection === "RecvOnly") {
			calls.getCallDiv().cwic('updateConversation', {videoDirection:'Inactive'});
			$callcontainer.find('.escalatebtn').text('Escalate');
		}
		else {
			alert("invalid value for video direction!");
		}

    }

    </script>
  </head>
  <body>
      <div class="alignright">
    <div id="logindetails">
        <label for="username">User Name:</label>
        <input type="text" id="username">
        <br>
        <label for="password">Password:</label>
        <input type="password" id="password"/>
        <br>
        <label for="cucm">CUCM:</label>
        <input type="text" id="cucm">
        <br>
        <label for="mode">Mode:</label>
        <select id="mode">
                <option value="SoftPhone">SoftPhone</option>
                <option value="DeskPhone">DeskPhone</option>
        </select>
        <br>
        <label for="auth" title="Additional server-side Authorisation">Server Auth:</label>
        <input type="checkbox" id="auth"></input><br />
        <label for="loginbtn"></label>
        <button id="loginbtn" type="button">Login</button>
        <button id="logoutbtn" type="button" disabled="true">Logout</button>
        <div id="aboutcontainer">
            <div><span>cwic version: </span><span id="jsversion"></span></div>
            <div><span>jQuery version: </span><span id="jqueryversion"></span></div>
            <div><span>plugin Version: </span><span id="pluginversion"></span></div>
            <div><span>ecc version: </span><span id="eccversion"></span></div>
        </div>
        <div id="devicedetails">
            <label for="devices">Device:</label><select id="devices"></select>
            <button id="connectbtn" type="button" disabled="disabled">Connect</button>
        </div>
    </div>
</div>
    <div id="phonecontainer"></div>
    <label for="dntodial" id="dnlabel">Number (and DTMF):</label>
    <input type="text" id="dntodial">
    <button type="button" id="callbtn" disabled="true">Make Call</button><input type="checkbox" id="videocall">with Video</input>
    <button type="button" id="switchmodebtn" disabled="true">Switch Phonemode</button><br>
    <ul id="calllist" class="calllist"></ul>
    <div id="msgcontainer"></div>
    <div class="videocontainer" id="localPreviewContainer"><span style="padding: 5px;">Local Preview</span><div id="localvidcontainer" tabindex="998"></div><span style="padding: 5px;"><input name="showlocalvideo" type="radio" value="On">On</input><input name="showlocalvideo" type="radio" checked="checked" value="Off">Off</input></span>
    </div>
    <div id="callcontainer" class="callcontainer" style="display:none">
        <div class="remotename"></div>
        <div class="callinfo"></div>
        <div id="videocontainer">
        <div class="videocontainer">
        <div id="remotevideocontainer" class="videocontainer" tabindex="999"></div><iframe class="off" id="pinpwindow" frameBorder="0" hspace="0" vspace="0" marginwidth="0" marginheight="0" scrolling="No" src="pinp.html"></iframe></div></div>
        <button type="button" class="muteaudiobtn">Mute Audio</button>
        <button type="button" class="mutevideobtn">Mute Video</button>
        <button type="button" class="holdresumebtn">Hold</button>
        <button type="button" class="endbtn">End Call</button>
        <button type="button" class="IMbtn" disabled="true">IM</button>
        <button type="button" class="webExbtn">webEx</button>
        <button type="button" id="fullscreenbtn">Fullscreen!</button>
        <button type="button" id="popoutbtn">Popout</button>
        <button id="showpinpvideo" type="button" class="off"><div class="pinp"></div></button>
        <br>
        <select id="conferencelist"></select>
        <button type="button" id="conferencebtn" disabled="true">Conference</button>
        <br><select id="transferlist"></select>
        <button type="button" id="transferbtn" disabled="true">Transfer</button>
		<br>
		<button type="button" class="escalatebtn" >Escalate</button>
    </div>
    <div id="incomingcontainer" class="incomingcontainer" style="display:none">
        <div class="message"></div>
        <button type="button" class="answerbtn">Answer</button>
        <button type="button" class="divertbtn">iDivert</button>
    </div>
    <div id="IMcontainer" class="IMcontainer" style="display:none">
        <div id="IMdialog" class="IMdialog"></div>
        <br>
        <input type="text" id="IMsender" onkeydown="processKey(event)">
        <br>
        <button type="button" class="sendbtn">Send</button>
        <button type="button" class="closebtn">Close</button>
    </div>
    <br>
    <div id="webExcontainer" class="webExcontainer" style="display:none">
        <div class="webExsetting">Webex Account Settings</div>
        <br>
        <label for="webExaddress">WebEx site Address: http://</label>
        <input type="text" id="webExaddress">
        <label for="webExaddress">.webex.com/</label>
        <br>
        <label for="webExusername">WebEx User Name:</label>
        <input type="text" id="webExusername">
        <br>
        <label for="webExpassword">WebEx Password:</label>
        <input type="password" id="webExpassword"/>
        <br>
        <br>
        <!--<div class="webExbuttons">-->
        <button type="button" id="doApply" class="applybtn">Apply</button>
        <button type="button" class="webExclosebtn">Close</button>
        <button type="button" class="startMeeting" id="startMeeting" style="display:none">One-Click Meeting</button>
    </div>
        <iframe id="loginFrame" class="loginFrame" name="loginFrame"></iframe><br>
        <div  style="display: inline-block;">
             <form id="urlLogin" target="loginFrame">
                    <input type="hidden" id="act" name="AT" value="LI"></input>
                    <input type="hidden" id='backupURL' name="BU" value="http://webcommunicator-dev/endaweb/bu.html"></input>
                    <input type="hidden" name="MU" value="GoBack"></input>
                    <input type="hidden" id="webexid" name="WID"></input>
                    <input type="hidden" id="passwd" name="PW"></input>
             </form>
         <form id="impromptuMeeting" method="POST" target="_blank">
           <input type="hidden" name="AT" value="IM"></input>
           <input type="hidden" id="wbxid" name="WID"></input>
           <input type="hidden" id="tckt" name="TK"></input>
           <input type="hidden" id="imbackupURL" name="BU" value="http://webcommunicator-dev/endaweb/bu.html"></input>
         </form>
        </div>
  </body>
</html>
